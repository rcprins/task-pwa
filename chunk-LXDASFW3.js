import{Ba as Q,C as V,D as A,E as F,Eb as Z,I as G,K as X,O as Y,Ob as N,P as z,Q as T,R as E,S as _,V as H,e as j,g as f,j as M,l as m,la as J,m as C,n as I,r as $,t as k,vb as W}from"./chunk-JYJ6DCPQ.js";var ee=class{constructor(c,e){this.dbService=c;this.local_db_table_name=e;window.addEventListener("online",()=>{this.handleOnline()})}entityChanges$=new M(void 0);handleOnline(){console.log("Syncing after getting online again '"+navigator.onLine+"'"),this.updateLocalDB()}watchEntities(){return this.entityChanges$.asObservable()}updateLocalDB(){k({remoteEntities:this.getAllRemoteInternal(),localEntities:this.dbService.getAll(this.local_db_table_name)}).subscribe(({remoteEntities:c,localEntities:e})=>{let r=c.filter(a=>a.id&&!e.some(s=>s.id===a.id)),t=e.filter(a=>a.id&&!c.some(s=>s.id===a.id)).map(a=>a.id),n=r.length?this.dbService.bulkAdd(this.local_db_table_name,r):I(null),i=t.length?this.dbService.bulkDelete(this.local_db_table_name,t):I(null);k([n,i]).subscribe(()=>{console.log("Local tasks synced with remote."),(r.length||t.length)&&this.entityChanges$.next(r)})})}getByIdLocal(c){return C(this.dbService.getByID(this.local_db_table_name,c))}getById(c){return this.getByIdLocal(c).pipe(V(void 0),G(e=>{if(e!==void 0)return I(e);debugger;return this.getByIdRemote(c).pipe(X(r=>this.add(r)))}))}add(c){return c.synced=!1,this.dbService.add(this.local_db_table_name,c)}update(c){return console.log("Updating local entity with id:'"+c.id+"' in local store"),c.synced=!1,this.dbService.update(this.local_db_table_name,c)}deleteEntity(c){if(!c.id)throw Error("Cannot delete enyity as it has has no id");let e=this.dbService.delete(this.local_db_table_name,c.id);return e.subscribe({next:()=>console.log("Delete success"),error:r=>console.error("Delete error",r)}),e}getAllRemote(){return this.updateLocalDB(),this.getAllLocal()}getAllLocal(){return this.dbService.getAll(this.local_db_table_name)}getAll(){return navigator.onLine?this.getAllRemote():this.getAllLocal()}};var x=function(o){return o.readonly="readonly",o.readwrite="readwrite",o}(x||{}),te=new T(null),re=new T("Indexed DB"),se=new T("Server Indexed DB");function ae(o,c){return o.objectStoreNames.contains(c)}function S(o,c,e){if(!o){e("You need to use the openDatabase function to create a database before you query it!");return}ae(o,c)||e(`objectStore does not exists: ${c}`)}function v(o,c){let e=o.transaction(c.storeName,c.dbMode);return e.onerror=c.error,e.onabort=c.abort,e}function D(o,c,e,r){return{storeName:c,dbMode:o,error:t=>{e(t)},abort:t=>{e(t)}}}var P=[];function b(o,c,e,r){return new Promise((t,n)=>{o||n("IndexedDB not available");let i=o.open(c,e),a;i.onsuccess=()=>{a=i.result,P.push(a),t(a)},i.onerror=()=>{n(`IndexedDB error: ${i.error}`)},typeof r=="function"&&(i.onupgradeneeded=s=>{r(s,a)})})}function q(o,c,e,r,t){return j(this,null,function*(){return new Promise((n,i)=>{if(!o)return;let a=o.open(c,e);a.onupgradeneeded=s=>j(this,null,function*(){let l=s.target.result,p=r.map(h=>j(this,null,function*(){if(!l.objectStoreNames.contains(h.store)){let u=l.createObjectStore(h.store,h.storeConfig);for(let g of h.storeSchema)u.createIndex(g.name,g.keypath,g.options)}}));yield Promise.all(p);let d=t&&t();if(d){let h=Object.keys(d).map(u=>parseInt(u,10)).filter(u=>u>s.oldVersion).sort((u,g)=>u-g);for(let u of h)d[u](l,a.transaction)}l.close(),n()}),a.onsuccess=s=>{s.target.result.close(),n()},a.onerror=s=>{i(s)}})})}function ce(o,c,e){if(!o||!c||!e)throw Error('Params: "dbName", "version", "storeName" are mandatory.');return new f(r=>{try{let t=c+1,n=indexedDB.open(o,t);n.onupgradeneeded=i=>{let a=i.target.result;a.deleteObjectStore(e),a.close(),console.log("onupgradeneeded"),r.next(),r.complete()},n.onerror=i=>r.error(i)}catch(t){r.error(t)}})}function le(o){return new Promise((c,e)=>{if(!o){e(new Error("No database to close"));return}try{o.close(),c()}catch(r){e(`Error closing database: ${r}`)}})}function y(){return function(o,c,e){let r=e.value;return e.value=function(...t){let n=r.apply(this,t);return n instanceof f?n.pipe(F(()=>j(this,null,function*(){let i=P.map(a=>j(this,null,function*(){yield le(a)}));yield Promise.all(i),P.length=0}))):n},e}}var de=(()=>{class o{constructor(e,r){this.dbConfigs=e,this.indexedDB=r,this.defaultDatabaseName=null,Object.values(this.dbConfigs).forEach((t,n,i)=>this.instanciateConfig(t,i.length===1))}instanciateConfig(e,r){return j(this,null,function*(){if(!e.name)throw new Error("NgxIndexedDB: Please, provide the dbName in the configuration");if((e.isDefault??!1)&&this.defaultDatabaseName)throw new Error("NgxIndexedDB: Only one database can be set as default");((e.isDefault??!1)&&!this.defaultDatabaseName||r)&&(this.defaultDatabaseName=e.name,this.selectedDb=e.name),yield q(this.indexedDB,e.name,e.version,e.objectStoresMeta,e.migrationFactory),b(this.indexedDB,e.name).then(t=>{t.version!==e.version&&(W()&&(console.warn(`
            Your DB Config doesn't match the most recent version of the DB with name ${e.name}, please update it
            DB current version: ${t.version};
            Your configuration: ${e.version};
            `),console.warn(`Using latest version ${t.version}`)),this.dbConfigs[e.name].version=t.version),t.close()})})}get dbConfig(){return this.dbConfigs[this.selectedDb]}getDatabaseVersion(){return new f(e=>{b(this.indexedDB,this.dbConfig.name,this.dbConfig.version).then(r=>{e.next(r.version),e.complete()}).catch(r=>e.error(`error during get version of database => ${r} `))})}selectDb(e){if(e=e??this.defaultDatabaseName,!e)throw new Error("No database name specified and no default database set.");if(!Object.keys(this.dbConfigs).includes(e))throw new Error(`NgxIndexedDB: Database ${e} is not initialized.`);this.selectedDb=e}createObjectStore(e,r){return j(this,null,function*(){let t=[e];yield q(this.indexedDB,this.dbConfig.name,++this.dbConfig.version,t,r)})}createDynamicObjectStore(e,r){return j(this,null,function*(){let t=[e];yield q(this.indexedDB,this.dbConfig.name,this.dbConfig.version,t,r)})}add(e,r,t){return new f(n=>{b(this.indexedDB,this.dbConfig.name,this.dbConfig.version).then(i=>{let s=v(i,D(x.readwrite,e,d=>n.error(d))).objectStore(e),p=!!t?s.add(r,t):s.add(r);p.onsuccess=d=>j(this,null,function*(){let h=d.target.result,u=s.get(h);u.onsuccess=g=>{n.next(g.target.result),n.complete()},u.onerror=g=>{n.error(g)}}),p.onerror=d=>{n.error(d)}}).catch(i=>n.error(i))})}bulkAdd(e,r){let t=new Promise((n,i)=>{b(this.indexedDB,this.dbConfig.name,this.dbConfig.version).then(a=>{let l=v(a,D(x.readwrite,e,n,i)).objectStore(e),p=r.map(d=>new Promise(h=>{let u=d.key;delete d.key;let B=!!u?l.add(d,u):l.add(d);B.onsuccess=O=>{let ie=O.target.result;h(ie)}}));n(Promise.all(p))}).catch(a=>i(a))});return C(t)}bulkDelete(e,r){let t=r.map(n=>new Promise((i,a)=>{b(this.indexedDB,this.dbConfig.name,this.dbConfig.version).then(s=>{let l=v(s,D(x.readwrite,e,a,i));l.objectStore(e).delete(n),l.oncomplete=()=>{this.getAll(e).pipe(A(1)).subscribe(d=>{i(d)})}}).catch(s=>a(s))}));return C(Promise.all(t))}getByKey(e,r){return new f(t=>{b(this.indexedDB,this.dbConfig.name,this.dbConfig.version).then(n=>{let s=v(n,D(x.readonly,e,t.error)).objectStore(e).get(r);s.onsuccess=l=>{t.next(l.target.result),t.complete()},s.onerror=l=>{t.error(l)}}).catch(n=>t.error(n))})}bulkGet(e,r){let t=r.map(n=>this.getByKey(e,n));return new f(n=>{$(t).subscribe(i=>{n.next(i),n.complete()})})}getByID(e,r){return new f(t=>{b(this.indexedDB,this.dbConfig.name,this.dbConfig.version).then(n=>{S(n,e,l=>t.error(l));let s=v(n,D(x.readonly,e,t.error,t.next)).objectStore(e).get(r);s.onsuccess=l=>{t.next(l.target.result)}}).catch(n=>t.error(n))})}getByIndex(e,r,t){return new f(n=>{b(this.indexedDB,this.dbConfig.name,this.dbConfig.version).then(i=>{S(i,e,d=>n.error(d));let p=v(i,D(x.readonly,e,n.error)).objectStore(e).index(r).get(t);p.onsuccess=d=>{n.next(d.target.result),n.complete()}}).catch(i=>n.error(i))})}getAll(e){return new f(r=>{b(this.indexedDB,this.dbConfig.name,this.dbConfig.version).then(t=>{S(t,e,s=>r.error(s));let a=v(t,D(x.readonly,e,r.error,r.next)).objectStore(e).getAll();a.onerror=s=>{r.error(s)},a.onsuccess=({target:{result:s}})=>{r.next(s),r.complete()}}).catch(t=>r.error(t))})}update(e,r){return new f(t=>{b(this.indexedDB,this.dbConfig.name,this.dbConfig.version).then(n=>{S(n,e,l=>t.error(l));let a=v(n,D(x.readwrite,e,l=>t.error(l))).objectStore(e),s=a.put(r);s.onsuccess=l=>j(this,null,function*(){let p=l.target.result,d=a.get(p);d.onsuccess=h=>{t.next(h.target.result),t.complete()}})}).catch(n=>t.error(n))})}bulkPut(e,r){let t;return new f(n=>{b(this.indexedDB,this.dbConfig.name,this.dbConfig.version).then(i=>{S(i,e,s=>n.error(s)),t=v(i,D(x.readwrite,e,s=>n.error(s)));let a=t.objectStore(e);r.forEach((s,l)=>{let p=a.put(s);l===r.length-1&&(p.onsuccess=d=>{t.commit(),n.next(d.target.result),n.complete()}),p.onerror=d=>{t.abort(),n.error(d)}})}).catch(i=>{t?.abort(),n.error(i)})})}delete(e,r){return new f(t=>{b(this.indexedDB,this.dbConfig.name,this.dbConfig.version).then(n=>{S(n,e,s=>t.error(s));let i=v(n,D(x.readwrite,e,s=>t.error(s)));i.objectStore(e).delete(r),i.onerror=s=>t.error(s),i.oncomplete=()=>{this.getAll(e).pipe(A(1)).subscribe({next:s=>{t.next(s)},error:s=>t.error(s),complete:()=>t.complete()})}}).catch(n=>t.error(n))})}deleteByKey(e,r){return new f(t=>{b(this.indexedDB,this.dbConfig.name,this.dbConfig.version).then(n=>{S(n,e,s=>t.error(s));let i=v(n,D(x.readwrite,e,s=>t.error(s)));i.objectStore(e).delete(r),i.onerror=s=>t.error(s),i.oncomplete=()=>{t.next(),t.complete()}}).catch(n=>t.error(n))})}deleteAllByIndex(e,r,t,n){return new f(i=>{b(this.indexedDB,this.dbConfig.name,this.dbConfig.version).then(a=>{S(a,e,h=>i.error(h));let d=v(a,D(x.readwrite,e,i.error)).objectStore(e).index(r).openCursor(t,n);d.onerror=h=>i.error(h),d.onsuccess=h=>{let u=h.target.result;u?(u.delete(),u.continue()):(i.next(),i.complete())}}).catch(a=>i.error(a))})}clear(e){return new f(r=>{b(this.indexedDB,this.dbConfig.name,this.dbConfig.version).then(t=>{S(t,e,a=>r.error(a));let n=v(t,D(x.readwrite,e,a=>r.error(a)));n.objectStore(e).clear(),n.onerror=a=>r.error(a),n.oncomplete=()=>{r.next(),r.complete()}}).catch(t=>r.error(t))})}deleteDatabase(){return new f(e=>{b(this.indexedDB,this.dbConfig.name,this.dbConfig.version).then(r=>j(this,null,function*(){r.close();let t=this.indexedDB.deleteDatabase(this.dbConfig.name);t.onsuccess=()=>{e.next(),e.complete()},t.onerror=n=>e.error(n),t.onblocked=()=>{console.warn("Delete blocked: Ensure all tabs, instances, or connections are closed. Database name:",this.dbConfig.name),e.error(new Error("Unable to delete database because it's blocked"))}})).catch(r=>e.error(r))})}openCursor(e){let{storeName:r,query:t,direction:n,mode:i=x.readonly}=e;return new f(a=>{b(this.indexedDB,this.dbConfig.name,this.dbConfig.version).then(s=>{S(s,r,h=>a.error(h));let l=v(s,D(i,r,a.error)),d=l.objectStore(r).openCursor(t,n);l.oncomplete=()=>a.complete(),d.onerror=h=>a.error(h),d.onsuccess=h=>{let u=h.target.result;u&&a.next(u)}}).catch(s=>a.error(s))})}openCursorByIndex(e){let{storeName:r,indexName:t,query:n,direction:i,mode:a=x.readonly}=e;return new f(s=>{b(this.indexedDB,this.dbConfig.name,this.dbConfig.version).then(l=>{S(l,r,g=>s.error(g));let p=v(l,D(a,r,s.error)),u=p.objectStore(r).index(t).openCursor(n,i);p.oncomplete=()=>s.complete(),u.onerror=g=>s.error(g),u.onsuccess=g=>{let B=g.target.result;B&&s.next(B)}}).catch(l=>s.error(l))})}getAllByIndex(e,r,t,n){return new f(i=>{b(this.indexedDB,this.dbConfig.name,this.dbConfig.version).then(a=>{S(a,e,u=>i.error(u));let d=v(a,D(x.readonly,e,i.error)).objectStore(e).index(r).openCursor(t,n),h=[];d.onerror=u=>i.error(u),d.onsuccess=u=>{let g=u.target.result;g?(h.push(g.value),g.continue()):(i.next(h),i.complete())}}).catch(a=>i.error(a))})}getAllKeysByIndex(e,r,t,n){return new f(i=>{b(this.indexedDB,this.dbConfig.name,this.dbConfig.version).then(a=>{S(a,e,u=>i.error(u));let p=v(a,D(x.readonly,e,i.error)).objectStore(e).index(r),d=[],h=p.openKeyCursor(t,n);h.onerror=u=>i.error(u),h.onsuccess=u=>{let g=u.target.result;if(g){let{primaryKey:B,key:O}=g;d.push({primaryKey:B,key:O}),g.continue()}else i.next(d),i.complete()}}).catch(a=>i.error(a))})}count(e,r){return new f(t=>{b(this.indexedDB,this.dbConfig.name,this.dbConfig.version).then(n=>{S(n,e,l=>t.error(l));let s=v(n,D(x.readonly,e,t.error)).objectStore(e).count(r);s.onerror=l=>t.error(l),s.onsuccess=l=>{t.next(l.target.result),t.complete()}}).catch(n=>t.error(n))})}countByIndex(e,r,t){return new f(n=>{b(this.indexedDB,this.dbConfig.name,this.dbConfig.version).then(i=>{S(i,e,d=>n.error(d));let p=v(i,D(x.readonly,e,n.error)).objectStore(e).index(r).count(t);p.onerror=d=>n.error(d),p.onsuccess=d=>{n.next(d.target.result),n.complete()}}).catch(i=>n.error(i))})}deleteObjectStore(e){return ce(this.dbConfig.name,++this.dbConfig.version,e)}getAllObjectStoreNames(){return new f(e=>{b(this.indexedDB,this.dbConfig.name,this.dbConfig.version).then(r=>{e.next(Array.from(r.objectStoreNames)),e.complete()}).catch(r=>e.error(r))})}static{this.\u0275fac=function(r){return new(r||o)(E(te),E(re))}}static{this.\u0275prov=Y({token:o,factory:o.\u0275fac})}}return m([y()],o.prototype,"getDatabaseVersion",null),m([y()],o.prototype,"add",null),m([y()],o.prototype,"bulkAdd",null),m([y()],o.prototype,"bulkDelete",null),m([y()],o.prototype,"getByKey",null),m([y()],o.prototype,"bulkGet",null),m([y()],o.prototype,"getByID",null),m([y()],o.prototype,"getByIndex",null),m([y()],o.prototype,"getAll",null),m([y()],o.prototype,"update",null),m([y()],o.prototype,"bulkPut",null),m([y()],o.prototype,"delete",null),m([y()],o.prototype,"deleteByKey",null),m([y()],o.prototype,"deleteAllByIndex",null),m([y()],o.prototype,"clear",null),m([y()],o.prototype,"deleteDatabase",null),m([y()],o.prototype,"openCursor",null),m([y()],o.prototype,"openCursorByIndex",null),m([y()],o.prototype,"getAllByIndex",null),m([y()],o.prototype,"getAllKeysByIndex",null),m([y()],o.prototype,"count",null),m([y()],o.prototype,"countByIndex",null),m([y()],o.prototype,"getAllObjectStoreNames",null),o})(),U=class{cmp(){return 0}databases(){return Promise.resolve([])}deleteDatabase(){return{onupgradeneeded:null,onblocked:null,onerror:null,onsuccess:null,error:null}}open(){return{onupgradeneeded:null,onblocked:null,onerror:null,onsuccess:null,error:null}}};function ne(){H(ne);let o=_(J),c=_(se,{optional:!0})??new U;return N(o)?_(Z).defaultView.indexedDB:c}var ue=(...o)=>{let c=o.reduce((e,r)=>(e[r.name]=r,e),{});return[de,{provide:te,useValue:c},{provide:re,useFactory:ne}]},_e=(()=>{class o{static forRoot(...e){return{ngModule:o,providers:[...ue(...e)]}}static{this.\u0275fac=function(r){return new(r||o)}}static{this.\u0275mod=Q({type:o})}static{this.\u0275inj=z({})}}return o})();var he=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),L={randomUUID:he};var R,pe=new Uint8Array(16);function K(){if(!R){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");R=crypto.getRandomValues.bind(crypto)}return R(pe)}var w=[];for(let o=0;o<256;++o)w.push((o+256).toString(16).slice(1));function oe(o,c=0){return(w[o[c+0]]+w[o[c+1]]+w[o[c+2]]+w[o[c+3]]+"-"+w[o[c+4]]+w[o[c+5]]+"-"+w[o[c+6]]+w[o[c+7]]+"-"+w[o[c+8]]+w[o[c+9]]+"-"+w[o[c+10]]+w[o[c+11]]+w[o[c+12]]+w[o[c+13]]+w[o[c+14]]+w[o[c+15]]).toLowerCase()}function ge(o,c,e){if(L.randomUUID&&!c&&!o)return L.randomUUID();o=o||{};let r=o.random??o.rng?.()??K();if(r.length<16)throw new Error("Random bytes length must be >= 16");if(r[6]=r[6]&15|64,r[8]=r[8]&63|128,c){if(e=e||0,e<0||e+16>c.length)throw new RangeError(`UUID byte range ${e}:${e+15} is out of buffer bounds`);for(let t=0;t<16;++t)c[e+t]=r[t];return c}return oe(r)}var fe=ge;export{ee as a,de as b,_e as c,fe as d};
